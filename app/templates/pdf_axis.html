{% extends 'base.html' %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Axis Bank Statement → JSON</h1>
<div class="card mb-4">
  <form id="axisForm" method="post" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-6 gap-3">
    <div class="md:col-span-2">
      <label class="text-sm text-slate-500">PDF File</label>
      <input type="file" name="file" accept="application/pdf" class="input" required>
    </div>
    <div>
      <label class="text-sm text-slate-500">Password (optional)</label>
      <input type="password" name="password" class="input" placeholder="Leave blank to use default">
    </div>
    <div class="md:col-span-3 grid grid-cols-3 gap-2 items-end">
      <div class="col-span-3 flex items-center gap-2 mt-2">
        <input id="save_json" name="save_json" type="checkbox" class="h-4 w-4">
        <label for="save_json" class="text-sm text-slate-700">Save parsed JSON on server</label>
      </div>
      <div>
        <label class="text-sm text-slate-500">Month</label>
        <select name="save_month" class="input">
          {% for m in range(1,13) %}
            <option value="{{ m }}" {% if cur_month and cur_month==m %}selected{% endif %}>{{ "%02d"|format(m) }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="text-sm text-slate-500">Year</label>
        <select name="save_year" class="input">
          {% for y in years %}
            <option value="{{ y }}" {% if cur_year and cur_year==y %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="flex items-end">
        <button class="btn" type="submit">Upload & Extract</button>
      </div>
    </div>
    <div class="flex items-end gap-2 md:col-span-1">
      <button class="btn-outline" type="button" onclick="submitJson()">View JSON</button>
    </div>
  </form>

  {% if saved_all %}
  <div class="card mt-4">
    <div class="text-sm text-slate-500 mb-2">Saved JSON files</div>
    <div class="overflow-auto">
      <table class="table">
        <thead>
          <tr>
            <th class="th">Month</th>
            <th class="th">File</th>
            <th class="th">Saved At</th>
            <th class="th">Size</th>
            <th class="th">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for f in saved_all %}
          <tr>
            <td class="td whitespace-nowrap">{{ ["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][f.month] }} {{ f.year }}</td>
            <td class="td">{{ f.name }}</td>
            <td class="td">{{ f.mtime }}</td>
            <td class="td">{{ f.size_kb }} KB</td>
            <td class="td">
              <a class="btn-outline" href="{{ url_for('pdf.axis_to_json') }}?view_year={{ f.year }}&view_month={{ f.month }}&view_file={{ f.name }}">View</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
  <script>
    function submitJson(){
      const form = document.getElementById('axisForm');
      const prevTarget = form.getAttribute('target');
      const prevAction = form.getAttribute('action');
      form.setAttribute('target','_blank');
      form.setAttribute('action','{{ url_for('pdf.axis_to_json') }}?format=json');
      form.submit();
      // restore
      if(prevTarget) form.setAttribute('target', prevTarget); else form.removeAttribute('target');
      if(prevAction) form.setAttribute('action', prevAction); else form.removeAttribute('action');
    }
  </script>
</div>

{% if json_rows is not none %}
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
  <div class="p-4 rounded bg-teal-50 dark:bg-slate-700/50">
    <div class="text-sm text-slate-500">Total Income (Cr)</div>
    <div class="text-3xl font-bold">₹ {{ '%.2f'|format(totals.income_total if totals else 0) }}</div>
  </div>
  <div class="p-4 rounded bg-emerald-50 dark:bg-slate-700/50">
    <div class="text-sm text-slate-500">Office Rental Income</div>
    <div class="text-3xl font-bold">₹ {{ '%.2f'|format(totals.office_income_total if totals and totals.office_income_total is defined else 0) }}</div>
  </div>
  <div class="p-4 rounded bg-cyan-50 dark:bg-slate-700/50">
    <div class="text-sm text-slate-500">Lodge Income</div>
    <div class="text-3xl font-bold">₹ {{ '%.2f'|format(totals.lodge_income_total if totals and totals.lodge_income_total is defined else 0) }}</div>
  </div>
  <div class="p-4 rounded bg-blue-50 dark:bg-slate-700/50">
    <div class="text-sm text-slate-500">Net</div>
    <div class="text-3xl font-bold">₹ {{ '%.2f'|format(totals.net if totals else 0) }}</div>
  </div>
</div>

<div class="card overflow-auto">
  <div class="flex items-center justify-between mb-2">
    <div class="text-sm text-slate-500">Extracted {{ json_rows|length }} transactions</div>
    <div class="flex items-center gap-2">
      <label class="text-sm text-slate-500">Sort by</label>
      <select id="sort_by" class="input w-40">
        <option value="date">Date</option>
        <option value="amount">Amount</option>
        <option value="tag">Tag (Office/Lodge)</option>
      </select>
      <select id="sort_dir" class="input w-32">
        <option value="asc">Ascending</option>
        <option value="desc" selected>Descending</option>
      </select>
      <button class="btn" type="button" onclick="sortAxisTable()">Apply</button>
    </div>
  </div>
  <table class="table" id="axisTable">
    <thead>
      <tr>
        <th class="th">Date</th>
        <th class="th">Particulars</th>
        <th class="th text-right">Debit</th>
        <th class="th text-right">Credit</th>
        <th class="th">Tag</th>
      </tr>
    </thead>
    <tbody>
      {% for r in json_rows %}
      {% set d0 = (r.date if r.date is defined else r['date']) %}
      {% set amt = (r.credit if (r.credit is defined and r.credit is not none) else (r['credit'] if r['credit'] is not none else None)) %}
      {% if amt is none %}
        {% set d_amt = (r.debit if (r.debit is defined and r.debit is not none) else (r['debit'] if r['debit'] is not none else 0)) %}
        {% set amt = 0 - d_amt %}
      {% endif %}
      <tr data-date="{{ d0 or '' }}" data-amount="{{ '%.2f'|format(amt or 0) }}" data-tag="{{ (r.income_type if r.income_type is defined else r['income_type']) if ('income_type' in r) else '' }}">
        <td class="td whitespace-nowrap">{% if d0 %}{% set p = d0.split('-') %}{{ p[2] }}-{{ p[1] }}-{{ p[0] }}{% else %}-{% endif %}</td>
        <td class="td">{{ r.particulars if r.particulars is defined else r['particulars'] }}</td>
        <td class="td text-right">{% if r.debit is defined and r.debit is not none %}₹ {{ '%.2f'|format(r.debit) }}{% elif r['debit'] is not none %}₹ {{ '%.2f'|format(r['debit']) }}{% else %}-{% endif %}</td>
        <td class="td text-right">{% if r.credit is defined and r.credit is not none %}₹ {{ '%.2f'|format(r.credit) }}{% elif r['credit'] is not none %}₹ {{ '%.2f'|format(r['credit']) }}{% else %}-{% endif %}</td>
        <td class="td">
          {% if r.income_type is defined %}
            {% if r.income_type == 'office' %}<span class="px-2 py-0.5 rounded bg-emerald-100 text-emerald-800 text-xs">Office</span>{% elif r.income_type == 'lodge' %}<span class="px-2 py-0.5 rounded bg-cyan-100 text-cyan-800 text-xs">Lodge</span>{% endif %}
          {% elif 'income_type' in r and r['income_type'] %}
            {% if r['income_type'] == 'office' %}<span class="px-2 py-0.5 rounded bg-emerald-100 text-emerald-800 text-xs">Office</span>{% elif r['income_type'] == 'lodge' %}<span class="px-2 py-0.5 rounded bg-cyan-100 text-cyan-800 text-xs">Lodge</span>{% endif %}
          {% else %}-{% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<script>
function sortAxisTable(){
  const by = document.getElementById('sort_by').value;
  const dir = document.getElementById('sort_dir').value;
  const tbody = document.querySelector('#axisTable tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const mul = dir === 'asc' ? 1 : -1;
  rows.sort((a,b)=>{
    if(by === 'date'){
      const da = (a.dataset.date||'');
      const db = (b.dataset.date||'');
      return (da > db ? 1 : da < db ? -1 : 0) * mul;
    } else if(by === 'tag'){
      const ta = (a.dataset.tag||'');
      const tb = (b.dataset.tag||'');
      return (ta > tb ? 1 : ta < tb ? -1 : 0) * mul;
    } else {
      const aa = parseFloat(a.dataset.amount||'0') || 0;
      const ab = parseFloat(b.dataset.amount||'0') || 0;
      return (aa > ab ? 1 : aa < ab ? -1 : 0) * mul;
    }
  });
  rows.forEach(r=>tbody.appendChild(r));
}
</script>
{% endif %}
{% endblock %}
